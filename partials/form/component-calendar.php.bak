<?php

declare(strict_types=1);

$page = $pageContext ?? [];
$bootstrap = $page['bootstrap'] ?? [];
$apiEndpoints = $page['apiEndpoints'] ?? [];
$label = $bootstrap['activity']['uiLabels']['calendar'] ?? 'Choose Your Date';
$currentDate = $bootstrap['environment']['currentDate'] ?? date('Y-m-d');
$calendarEndpoint = $apiEndpoints['availability'] ?? null;

try {
    $current = new \DateTimeImmutable($currentDate);
} catch (\Exception) {
    $current = new \DateTimeImmutable();
}

$monthStart = $current->modify('first day of this month');
$gridStart = $monthStart->modify(sprintf('-%d days', (int) $monthStart->format('w')));
$today = new \DateTimeImmutable('today');
$weeks = [];

for ($index = 0; $index < 42; $index++) {
    $day = $gridStart->modify(sprintf('+%d days', $index));
    $weeks[(int) floor($index / 7)][] = $day;
}

$weekdayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
?>
<section class="space-y-3" data-component="calendar">
    <header>
        <h2 class="text-lg font-semibold text-slate-900 mb-0"><?= htmlspecialchars($label, ENT_QUOTES, 'UTF-8') ?></h2>
        <p class="text-sm text-slate-600 mb-0">Select a date to see available departure/start times.</p>
    </header>

    <div class="relative rounded-xl border border-slate-200 p-5 shadow-xs" data-calendar>
        <div class="absolute inset-0 z-10 hidden items-center justify-center rounded-xl bg-white" data-calendar-loading>
            <div class="h-10 w-10 animate-spin rounded-full border-4 border-t-transparent border-[var(--sgc-brand-primary)]"></div>
        </div>

        <div class="flex items-center justify-between" data-calendar-navigation>
            <button type="button"
                    class="flex h-9 w-9 items-center justify-center rounded-full text-slate-400 transition-colors hover:text-slate-700 focus:outline-none focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-400/70"
                    data-action="previous-month"
                    aria-label="Previous month">
                <span aria-hidden="true" class="text-lg">&#8249;</span>
            </button>
            <p class="text-base font-semibold text-slate-900" data-calendar-month-label>
                <?= htmlspecialchars($current->format('F Y'), ENT_QUOTES, 'UTF-8') ?>
            </p>
            <button type="button"
                    class="flex h-9 w-9 items-center justify-center rounded text-slate-400 transition-all duration-300 hover:text-slate-700 focus:outline-none focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-400/70"
                    data-action="next-month"
                    aria-label="Next month">
                <span aria-hidden="true" class="text-xl">&#8250;</span>
            </button>
        </div>

        <div class="mt-6 grid grid-cols-7 gap-0 md:gap-3 text-center text-xs font-semibold uppercase tracking-wide text-slate-400">
            <?php foreach ($weekdayLabels as $weekday): ?>
                <span><?= htmlspecialchars($weekday, ENT_QUOTES, 'UTF-8') ?></span>
            <?php endforeach; ?>
        </div>

        <div class="mt-4 grid grid-cols-7 gap-0 md:gap-3" role="grid" aria-label="Available dates">
            <?php foreach ($weeks as $week): ?>
                <?php foreach ($week as $day): ?>
                    <?php
                    $dateValue = $day->format('Y-m-d');
                    $monthValue = $day->format('Y-m');
                    $isCurrentMonth = $monthValue === $current->format('Y-m');
                    $isPast = $day < $today;
                    $isSelected = $dateValue === $current->format('Y-m-d');
                    ?>
                    <div role="gridcell" class="flex justify-center">
                        <button type="button"
                                class="flex h-12 w-12 items-center justify-center rounded-full text-sm font-medium transition-all focus:outline-none focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-400/70"
                                data-date="<?= htmlspecialchars($dateValue, ENT_QUOTES, 'UTF-8') ?>"
                                data-month="<?= htmlspecialchars($monthValue, ENT_QUOTES, 'UTF-8') ?>"
                                <?= $isCurrentMonth ? '' : 'data-outside-month="1"' ?>
                                <?= $isSelected ? 'data-selected="1"' : '' ?>
                                <?= $isPast ? 'disabled' : '' ?>>
                            <time datetime="<?= htmlspecialchars($dateValue, ENT_QUOTES, 'UTF-8') ?>"
                                  class="text-base <?= $isCurrentMonth ? 'text-slate-700' : 'text-slate-300' ?>">
                                <?= $day->format('j') ?>
                            </time>
                        </button>
                    </div>
                <?php endforeach; ?>
            <?php endforeach; ?>
        </div>
    </div>
    
</section>
