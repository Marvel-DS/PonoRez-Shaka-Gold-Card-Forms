<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Snorkel Cruise Booking</title>
  <script src="https://cdn.tailwindcss.com"></script>
<script type="text/javascript" src="https://ponorez.online/reservation/common/jquery/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="https://ponorez.online/reservation/common/calendar_js.jsp?jsversion=20250423"></script>
<script type="text/javascript" src="https://ponorez.online/reservation/external/functions.js?jsversion=20250423"></script>
<script type="text/javascript" src="https://ponorez.online/reservation/external/bookingsupport-1.js?jsversion=20250423"></script>
</head>
<body class="bg-gray-100">
  <div class="max-w-xl mx-auto mt-10 p-6 bg-white rounded-2xl shadow-md space-y-6">
    <h2 class="text-xl font-bold text-gray-800">Deluxe Morning Snorkel Cruise</h2>

    <!-- Guest Types -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Guests</label>
      <div id="guest-types" class="space-y-2">
        <!-- Filled dynamically -->aa
      </div>
    </div>

    <!-- Date -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Activity Date</label>
      <input type="text" id="activity-date" class="dateTextInput border rounded p-2 w-full" readonly />
    </div>

    <!-- Time Slots -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Time Slots</label>
      <select id="time-slots" class="border rounded p-2 w-full">
        <option value="">-- Select a times --</option>
      </select>
    </div>

    <!-- Shaka Gold Card -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Shaka Gold Card</label>
      <input type="text" id="goldcard-number" class="border rounded p-2 w-full"
        placeholder="Enter your Shaka Gold Card number" />
      <label class="inline-flex items-center space-x-2 text-sm">
        <input type="checkbox" id="buy-goldcard" class="rounded" />
        <span>Buying for someone else? Add a Shaka Gold Card $30</span>
      </label>
    </div>

    <!-- Book Now -->
    <button id="book-now"
      class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-xl shadow hover:bg-blue-700 transition">
      Book Now
    </button>

    <!-- Price -->
    <div id="price-summary" class="text-sm text-gray-600 hidden">
      Total: <span id="total-price" class="font-bold text-gray-900"></span>
    </div>
  </div>

  <script>
    const supplierId = 188;
    const activityId = 5263;

    // Proxy base URL (your PHP proxy)
    const API_BASE = "/SCG/proxy.php";

    async function loadGuestTypes(date) {
      const res = await fetch(`${API_BASE}?action=guest-types&supplierId=${supplierId}&activityId=${activityId}&date=${date}`);
      const data = await res.json();

      const container = document.getElementById("guest-types");
      container.innerHTML = "";

      // Only allow specific guest type IDs
      const allowedGuestTypeIds = [214, 1882, 215];
      const validGuestTypes = data.filter(gt =>
        allowedGuestTypeIds.includes(Number(gt.id))
      );

      validGuestTypes.forEach(gt => {
        const div = document.createElement("div");
        div.className = "flex justify-between items-center";
        div.innerHTML = `
          <span>${gt.name} - $${parseFloat(gt.price).toFixed(2)}</span>
          <select class="border rounded p-1 w-20" data-guest-id="${gt.id}">
            ${[...Array(11).keys()].map(i => `<option value="${i}">${i}</option>`).join('')}
          </select>
        `;
        container.appendChild(div);
      });
    }

    async function loadTimeSlots(date) {
      const res = await fetch(`${API_BASE}?action=times&supplierId=${supplierId}&activityId=${activityId}&date=${date}`);
      const data = await res.json();

      const select = document.getElementById("time-slots");
      select.innerHTML = `<option value="">-- Select a time --</option>`;
      data.forEach(slot => {
        const opt = document.createElement("option");
        opt.value = slot.id;
        opt.textContent = `${slot.label} (${slot.available} seats left)`;
        select.appendChild(opt);
      });
    }

    // Hook into jQuery calendar change event
    $("#activity-date").on("change", function () {
      const rawDate = $(this).val();

      if (rawDate) {
        // Convert from MM/DD/YYYY â†’ YYYY-MM-DD
        const parts = rawDate.split("/");
        const formattedDate = `${parts[2]}-${parts[0].padStart(2,"0")}-${parts[1].padStart(2,"0")}`;

        loadGuestTypes(formattedDate);
        loadTimeSlots(formattedDate);
      }
    });

    document.getElementById("book-now").addEventListener("click", async () => {
      const date = document.getElementById("activity-date").value;
      const timeSlot = document.getElementById("time-slots").value;
      const goldCard = document.getElementById("goldcard-number").value;
      const buyGoldCard = document.getElementById("buy-goldcard").checked;

      const guestCounts = Array.from(document.querySelectorAll("#guest-types select"))
        .map(sel => ({ id: sel.dataset.guestId, count: parseInt(sel.value) }))
        .filter(g => g.count > 0);

      const payload = { supplierId, activityId, date, timeSlot, guestCounts, voucherId: goldCard || null, buyGoldCard };

      const res = await fetch(API_BASE + "?action=book", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();

      document.getElementById("price-summary").classList.remove("hidden");
      document.getElementById("total-price").textContent = `$${data.total.toFixed(2)}`;
    });
  </script>
  
</body>
</html>